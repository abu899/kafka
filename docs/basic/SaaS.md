# 카프카 클러스터를 운영하는 방법

기본적으로는 아파치 카프카 클러스터를 서버에 직접 설치하여 운영하는 방법이 가장 전통적이고 기본적인 방식이다.
이 방법은 세세하게 컨트롤하고 최적의 클러스터를 만들어내기 위해서 어느정도의 노하우가 필요하게된다. 
따라서, 카프카 클러스터를 사용하기 위해 시행착오를 겪게되며, 각종 보안설정이나 모니터링 도구 설치에 있어 어려움을 겪을 수 있다.
이런 운영상 시행착오를 줄이면서 카프카를 `SaaS(Software-as-a-Service)` 방식으로 도입할 수도 있다.

## 설치 방법별 서비스 형태 종류

### On-Premise

- 사용자가 자체적으로 서버에 직접 설치해 운영
- 기업 상황에 맞게 하드웨어를 커스터마이징 구성 가능
- 초기 도입 비용
- 운영 및 관리를 위한 유지보수 비용 발생
- 카프카 운영 방법
  - 서버 구매 + 네트워크 설치 구성 수행 및 운영체제 설치
  - 오픈소스 카프카를 설치 및 운영
    - 또는 기업용 카프카(컨플루언트 플랫폼) 설치, 운영

### IaaS (Infrastructure-as-a-Service)

- 물리, 가상 컴퓨팅 리소스를 발급받아서 사용(ex. Aws, GCP)
- 온라인 스토리지, 데이터베이스 등도 포함
- 사용자가 운영체제, 어플리케이션 등을 직접 설정, 배포, 운영
- 카프카 운영 방법
  - AWS, GCP 와 같은 클라우드 서비스를 통해 설치
  - 컴퓨팅 리소스(인스턴스)에 오픈소스 카프카 설치 및 운영
    - 또는 기업용 카프카 설치, 운영

### PaaS(Platform-as-a-Service)

- 어플리케이션 개발 및 실행 환경을 제공(ex. Aws Lambda)
- 사용자는 컴퓨팅 리소스 관리를 신경쓰지 않아도 됨
- 세세한 튜닝옵션은 제한적으로 제공된다

### SaaS(Software-as-a-Service)

- 소프트웨어 배포, 실행을 업체에서 관리하고 기능만 제공
- 관리자체를 업체에 위임하고 기능만 사용할 떄 유용
- 카프카를 운영 경험이 없거나 노하우 경험이 없다면 추천
- 카프카 운영 방법
  - 컨프루언트 클라우드 또는 Aws MSK 가 대표적인 SaaS
  - 다양한 주변 생테계를 옵션으로 제공
    - ksqlDB
      - sql 구문으로 카프카 토픽의 데이터를 처리
    - 모니터링 도구 등

## 오픈 소스 카프카를 직접 설치하는 경우

IaaS 나 온프레미스 환경에서 설치하는 것이 가장 흔한 운영방식이다. 카프카는 데이터를 모두 파일시스템에 저장하고 
대규모 데이터 통신이 일어나기에 고성능 하드웨어가 사용된다

- Specification
  - 메모리: 32GB 중 힙 메모리로 6GB 할당, 나머지는 OS의 페이지 캐시 영역으로 사용 
  - CPU: 24 core
  - 디스크: RAID 10으로 설정된 디스크, NAS 사용 금지
  - 네트워크: 데이터 통신량에 따라 다름
  - 파일시스템: XFS 또는 ext4

---

## SaaS 형 아파치 카프카

오픈소스 카프카에서 필요한 기능을 추가한 기업용 카프카이다. 오픈소스 카프카의 기능을 확장시키고 발전시키는 역할을 하고 있다.

## SaaS의 장점

### 인프라 관리의 효율화

- 자동으로 브로커가 올라가는 서버를 관리해줌
- 이슈가 발생한 브로커를 재시작하거나 이슈가 발생하더라도 자동으로 클러스터를 복구
- 데이타 사용량이 늘어나더라도 대시보드를 통해 간단하게 스케일 아웃 가능
 
### 모니터링 대시보드 제공

기본적으로 사용환경에서 최소 3대 이상의 서버(브로커)로 운영하는데 3대 이상의 서버를 모니터링해야하는 역할에 자유로울 수 있다.

- 브로커들이 제공하는 지표들을 수집하고 적재하여 시각화를 통해 카프카를 보다 효과적으로 운영하게 도움을 줌
- 지표를 수집하게 되면 그 갯수가 너무 많기 떄문에 중요한 것을 알아가는 시간또한 줄일 수 있음
- 지표를 저장할 저장소를 구축하고 대시보드를 운영하기 위한 추가 플랫폼 설치가 필요 없음

### 보안 설정

보안이 설정되지 않았다면 호스트와 포트 번호만 알면 모든 토픽의 데이터를 가져갈 수 있다.
아파치 카프카에서 기본적으로 보안설정을 제공하고는 있지만 실질적으로 모든 브로커에 설치, 운영하는건 다른 문제이다.
단순히 문서로 제공되는 다양한 종류의 설정방식에서 어떤 종류의 보안설정을 할지 고르고 운영하는건 어려운 문제이다.

- SaaS 에서는 클러스터 접속시 보안 설정을 기본적으로 제공
- 클러스터 생성 시 보안 설정을 통해 인가된 사용자만 카프카 클러스터에 접근할 수 있도록 설정 가능

## SaaS의 단점

### 서비스 사용 비용

직접 설치를 통해 운영한다면 브로커와 실행되는 서버의 사용 비용만 들지만, SaaS 를 사용하는 경우 특정 요금제를 사용해야한다.

- MSK 의 경우 3대의 브로커로 인스턴스를 구성하기에 시간당 1.5달러, 한달에 120만원의 비용이 발생
- 만약 인스턴스만 발급받고 설치하게 되면 60만원 정도로 2배이상 저렴하지만 이를 관리할 사람이 필요하다

### 커스터마이징의 제한

- 서버의 최적화 옵션이나 카프카 브로커 옵션같은 다양한 부분에서 사용자 설정이 들어감
- 하지만 SaaS 서비스들은 클러스터 아키텍쳐의 변화가 필요한 경우 적용하기가 어려움
  - 멀티 클라우드나 하이브리드 클라우드 형태로는 서비스가 불가

### 클라우드 종속성

- 서비스 업체를 선택하고 클러스터를 운영하게 되면 해당 서비스 업체에 종속
  - 비용이나 운영상 추가 기능에 따라 클러스터의 데이터를 옮겨야 하는 상황이 발생할 수 있음
- 추후 발생할 수 있는 이슈를 예측해보고 서비스에 미치는 위험 정도를 따져본뒤 도입해야함
   
### 클라우드 기반 카프카 클러스터

- 요구사항에 따라 자동으로 늘려주는 클러스터 리소스 제공
- GCP, AWS 등 클러스터 설치 위치 지정(리전 단위) 가능
- 120개가 넘는 커넥터, 플러그인 등을 제공
  - plugin
    - connector
    - ksqldb
    - rest proxy 등
- 엔터프라이즈 수준의 보안 수준 제공
- 데이터 적재 제한 없음

### 컨프루언트 플랫폼

- 온프레스 기반 설치형 카프카 클러스터
- 서버를 내부에서 발급하여 직접 설치
- 단계별 스토리지 기능을 제공
- GUI 기반 모니터링 시스템 제공

### AWS MSK(Managed Streaming for Apache Kafka)

- AWS 에서 제공하는 SaaS 형 아파치 카프카 서비스
- 카프카 클러스터를 생성, 업데이트, 삭제 등의 운영요소를 대시보드를 통해 제공
- AWS 에 운영하는 어플리케이션과 쉽게 연동 가능
- 안전한 접속을 위해 TLS 인증 보안을 설정 가능



